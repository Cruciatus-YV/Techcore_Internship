using Microsoft.AspNetCore.Mvc;

namespace Techcore_Internship.WebApi.Controllers;

[ApiController]
public class Task345_1_CookiesTokensController : ControllerBase
{
    [HttpGet]
    [Route("cookies-vs-tokens")]
    public IActionResult GetCookiesVsTokens()
    {
        var explanation = @"    В современных распределенных системах, построенных по принципу микросервисной архитектуры, выбор механизма аутентификации играет ключевую роль. 
Stateless-подход, при котором сервер не хранит состояние сессии между запросами, стал стандартом для таких систем, поскольку обеспечивает горизонтальную масштабируемость и отказоустойчивость. 
В этом контексте особенно актуален спор между традиционной cookie-based аутентификацией и более современной token-based аутентификацией, реализованной через JWT (JSON Web Tokens).

            Ключевые различия в механике работы:

    - Cookie-based аутентификация исторически доминировала в классических MVC-приложениях. 
В этой модели браузер автоматически прикрепляет cookies (небольшие фрагменты данных, устанавливаемые сервером) к каждому HTTP-запросу на соответствующий домен. 
Это идеально согласуется с паттерном MVC, где фронтенд и бэкенд тесно связаны и работают в рамках одного домена. 
Однако для микросервисов, которые часто обслуживают запросы от разных клиентов (мобильные приложения, SPA, другие сервисы), эта модель показывает свои недостатки.

    - Token-based аутентификация, в частности с использованием JWT, реализует иной подход. 
После успешного входа пользователя сервер аутентификации генерирует подписанный токен, который клиент (например, мобильное приложение или фронтенд) сохраняет и вручную добавляет в заголовок каждого последующего запроса (обычно Authorization: Bearer <token>). 
Этот токен является самодостаточным (self-contained) — он содержит в себе всю необходимую информацию о пользователе (claims), и его подпись гарантирует целостность и подлинность.

            Stateless-архитектура и JWT

Главное преимущество JWT для stateless микросервисов заключается в его полной независимости от состояния сервера. 
Каждый микросервис, получив запрос с JWT, может проверить его валидность, сверив только электронную подпись, не делая запросов к центральной базе данных или серверу сессий. 
Это кардинально снижает сетевую нагрузку и избавляет от единой точки отказа. Вся сессионная информация инкапсулирована в самом токене.
В отличие от этого, классические сессионные cookies, даже в stateless-концепции, часто требуют хранения состояния сессии на сервере (в in-memory хранилище, like Redis) или в зашифрованном виде внутри самой cookie (encrypted cookie sessions). Первый вариант нарушает принцип stateless, а второй создает избыточную нагрузку на сервер, которому приходится расшифровывать и проверять cookie при каждом запросе, что менее эффективно, чем проверка подписи JWT.

            Проблема CORS (Cross-Origin Resource Sharing)

Этот критерий является одним из наиболее критичных. Микросервисная архитектура часто подразумевает, что API-шлюз, фронтенд и различные бэкенд-сервисы располагаются на разных доменах или поддоменах (cross-origin). 
Cookies привязаны к домену и не отправляются автоматически на другие домены. 
При попытке сделать запрос с одного домена на другой браузер запускает сложный механизм CORS, требуя от сервера специальных заголовков.
Это создает значительные накладные расходы и сложности в настройке.
JWT-токены, передаваемые в заголовках, свободны от этой проблемы. 
Клиент явно управляет заголовками и может без ограничений со стороны браузера отправлять токен на любой сервер, что идеально подходит для взаимодействия между независимыми микросервисами и разнородными клиентами.

            Заключение

Таким образом, для экосистемы stateless микросервисов token-based аутентификация на основе JWT является предпочтительным выбором. 
Она обеспечивает истинную stateless-архитектуру, упрощает межсервисное взаимодействие в условиях cross-origin и предоставляет большую гибкость для различных типов клиентов. 
Cookies же остаются оптимальным решением для монолитных MVC-приложений, где вся логика сосредоточена в рамках одного домена, и браузер может эффективно управлять сессией. 
Выбор между ними — это выбор между старой, проверенной моделью единого веб-приложения и новой, гибкой парадигмой распределенных систем.";

        return Ok(explanation);
    }
}
